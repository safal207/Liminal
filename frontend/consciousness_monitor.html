<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consciousness States WebSocket Test</title>
    <style>
        /* Oxford-style минималистичный дизайн с четкой структурой */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 2rem;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
        }
        .state-card {
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        .state-card.highlight {
            box-shadow: 0 0 10px rgba(0,100,255,0.5);
            border-color: #0066ff;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .metric {
            background: #f5f5f5;
            padding: 0.5rem;
            border-radius: 3px;
            font-size: 0.9rem;
        }
        .node-liminal { border-left: 4px solid #9c27b0; }
        .node-presence { border-left: 4px solid #2196f3; }
        .node-harmony { border-left: 4px solid #4caf50; }
        .node-home { border-left: 4px solid #ff9800; }
        .node-question { border-left: 4px solid #f44336; }
        
        .event-log {
            margin-top: 2rem;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 1rem;
            background: #fafafa;
        }
        
        /* MIT Media Lab стиль интерфейса - понятные действия */
        .controls {
            margin: 2rem 0;
            display: flex;
            gap: 1rem;
        }
        button {
            padding: 0.5rem 1rem;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        button:hover {
            background: #0055dd;
        }
        h1, h2 {
            font-weight: 300;
            color: #222;
        }
        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        /* Morpheus Choice Styles */
        .morpheus-container {
            display: none; /* Hidden by default */
            padding: 2rem;
            margin-top: 2rem;
            border: 1px dashed #f44336;
            background: #212121;
            color: #eee;
            text-align: center;
            border-radius: 4px;
        }
        .morpheus-container h3 {
            font-weight: 400;
            color: #fff;
        }
        .morpheus-pills {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        .pill-btn {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            border-radius: 20px;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .pill-btn.red {
            background-color: #d32f2f;
            border-color: #ffcdd2;
            color: white;
        }
        .pill-btn.red:hover {
            background-color: #e53935;
            box-shadow: 0 0 15px #ff7961;
        }
        .pill-btn.blue {
            background-color: #1976d2;
            border-color: #bbdefb;
            color: white;
        }
        .pill-btn.blue:hover {
            background-color: #1e88e5;
            box-shadow: 0 0 15px #63a4ff;
        }
    </style>
</head>
<body>
    <h1>Consciousness States Real-time Monitor</h1>
    <div class="status disconnected" id="connection-status">WebSocket: Disconnected</div>
    
    <div class="controls">
        <button id="connect-btn">Connect</button>
        <button id="disconnect-btn" disabled>Disconnect</button>
        <button id="simulate-btn">Simulate Transition</button>
        <button id="trigger-morpheus-btn" style="background-color: #9c27b0;">Trigger Morpheus Choice</button>
    </div>

    <div class="morpheus-container" id="morpheus-choice-container">
        <h3>The time has come to make a choice.</h3>
        <p>The path of comfort, or the path of truth. There is no turning back.</p>
        <div class="morpheus-pills">
            <button id="blue-pill-btn" class="pill-btn blue">The Blue Pill</button>
            <button id="red-pill-btn" class="pill-btn red">The Red Pill</button>
        </div>
    </div>
    
    <h2>Current Consciousness States</h2>
    <div id="states-container"></div>
    
    <h2>Event Log</h2>
    <div class="event-log" id="event-log"></div>
    
    <script>
        // MIT-style модульность и разделение ответственности
        const ConsciousnessMonitor = (function() {
            // Приватные переменные
            let ws = null;
            let states = {};
            
            // Oxford-style формальное определение состояний сознания
            const stateDefinitions = {
                "TRANSITION_LIMINAL": {
                    label: "Лиминальное переходное",
                    description: "Между мирами, в процессе становления",
                    colorClass: "node-liminal"
                },
                "PRESENCE_NOW": {
                    label: "Осознанное присутствие",
                    description: "Полное присутствие в настоящем моменте",
                    colorClass: "node-presence"
                },
                "HARMONY_BALANCE": {
                    label: "Гармония и баланс",
                    description: "Состояние внутреннего равновесия и целостности",
                    colorClass: "node-harmony"
                },
                "HOME_AUTHENTIC": {
                    label: "Аутентичный дом",
                    description: "Дом - это ты, когда искренен с собой",
                    colorClass: "node-home"
                },
                "QUESTION_SPACE": {
                    label: "Пространство вопросов",
                    description: "Мы научились задавать правильные вопросы",
                    colorClass: "node-question"
                }
            };
            
            // Oxford-style чистые функции для работы с данными
            function renderStates() {
                const container = document.getElementById('states-container');
                container.innerHTML = '';
                
                Object.values(states).forEach(state => {
                    const stateDefinition = stateDefinitions[state.id] || {
                        label: state.id,
                        description: "Undefined state",
                        colorClass: ""
                    };
                    
                    const stateEl = document.createElement('div');
                    stateEl.className = `state-card ${stateDefinition.colorClass}`;
                    stateEl.id = `state-${state.id}`;
                    
                    stateEl.innerHTML = `
                        <h3>${stateDefinition.label}</h3>
                        <p>${stateDefinition.description}</p>
                        <div class="metrics">
                            <div class="metric">Presence: ${state.presenceLevel || 0}</div>
                            <div class="metric">Harmony: ${state.harmonyIndex || 0}</div>
                            <div class="metric">Authenticity: ${state.authenticityScore || 0}</div>
                            <div class="metric">Emotional: ${state.emotionalCharge || 0}</div>
                        </div>
                    `;
                    
                    container.appendChild(stateEl);
                });
            }
            
            function logEvent(message, type = 'info') {
                const logEl = document.getElementById('event-log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type}`;
                entry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
                logEl.appendChild(entry);
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            function highlightState(stateId) {
                // Сначала уберем все выделения
                document.querySelectorAll('.state-card').forEach(el => {
                    el.classList.remove('highlight');
                });
                
                // Теперь выделим нужное состояние
                const stateEl = document.getElementById(`state-${stateId}`);
                if (stateEl) {
                    stateEl.classList.add('highlight');
                    setTimeout(() => stateEl.classList.remove('highlight'), 2000);
                }
            }
            
            // MIT-style публичное API с чёткими контрактами
            return {
                connect: function() {
                    if (ws) return;
                    
                    try {
                        ws = new WebSocket('ws://localhost:8000/ws/timeline'); // Adjusted port to 8000 for backend
                        
                        ws.onopen = () => {
                            document.getElementById('connection-status').className = 'status connected';
                            document.getElementById('connection-status').textContent = 'WebSocket: Connected';
                            document.getElementById('connect-btn').disabled = true;
                            document.getElementById('disconnect-btn').disabled = false;
                            logEvent('WebSocket соединение установлено');
                            
                            // Запрашиваем начальное состояние
                            // fetch('http://localhost:8000/api/consciousness/graph') // Placeholder URL
                            //     .then(response => response.json())
                            //     .then(data => {
                            //         data.nodes.forEach(node => {
                            //             states[node.id] = node;
                            //         });
                            //         renderStates();
                            //         logEvent(`Загружено ${data.nodes.length} состояний сознания`);
                            //     })
                            //     .catch(err => {
                            //         logEvent(`Ошибка получения данных: ${err.message}`, 'error');
                            //         console.error('Ошибка:', err);
                            //     });
                        };
                        
                        ws.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                // Handle future event types, e.g., morpheus trigger
                                if (data.type === 'morpheus_choice_available') {
                                    this.showMorpheusChoice();
                                } else {
                                    logEvent(`Получено событие: ${data.type} (${data.source} → ${data.target})`);
                                    highlightState(data.target);
                                }
                            } catch (e) {
                                logEvent(`Ошибка обработки сообщения: ${e.message}`, 'error');
                            }
                        };
                        
                        ws.onerror = (error) => {
                            logEvent(`Ошибка WebSocket: ${error.message}`, 'error');
                        };
                        
                        ws.onclose = () => {
                            document.getElementById('connection-status').className = 'status disconnected';
                            document.getElementById('connection-status').textContent = 'WebSocket: Disconnected';
                            document.getElementById('connect-btn').disabled = false;
                            document.getElementById('disconnect-btn').disabled = true;
                            logEvent('WebSocket соединение закрыто');
                            ws = null;
                        };
                    } catch (e) {
                        logEvent(`Ошибка создания WebSocket: ${e.message}`, 'error');
                    }
                },
                
                disconnect: function() {
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                },
                
                simulateTransition: function() {
                    logEvent('Симуляция перехода еще не подключена к бэкенду.');
                },

                showMorpheusChoice: function() {
                    const container = document.getElementById('morpheus-choice-container');
                    container.style.display = 'block';
                    logEvent('Morpheus choice presented.', 'special');
                },

                hideMorpheusChoice: function() {
                    const container = document.getElementById('morpheus-choice-container');
                    container.style.display = 'none';
                },

                sendMorpheusChoice: function(choice) {
                    const payload = {
                        user_id: 'test-user-01', // Dummy user_id for now
                        choice: choice
                    };

                    logEvent(`Sending choice: ${choice}...`);

                    fetch('http://localhost:8000/morpheus/choice', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Network response was not ok (${response.status})`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        logEvent(`Choice processed: ${data.message}`, 'success');
                        this.hideMorpheusChoice();
                    })
                    .catch(error => {
                        logEvent(`Error sending choice: ${error.message}`, 'error');
                    });
                }
            };
        })();
        
        // MIT-style обработка событий
        document.getElementById('connect-btn').addEventListener('click', () => {
            ConsciousnessMonitor.connect();
        });
        
        document.getElementById('disconnect-btn').addEventListener('click', () => {
            ConsciousnessMonitor.disconnect();
        });
        
        document.getElementById('simulate-btn').addEventListener('click', () => {
            ConsciousnessMonitor.simulateTransition();
        });

        // Morpheus event listeners
        document.getElementById('trigger-morpheus-btn').addEventListener('click', () => {
            ConsciousnessMonitor.showMorpheusChoice();
        });

        document.getElementById('blue-pill-btn').addEventListener('click', () => {
            ConsciousnessMonitor.sendMorpheusChoice('blue');
        });

        document.getElementById('red-pill-btn').addEventListener('click', () => {
            ConsciousnessMonitor.sendMorpheusChoice('red');
        });
        
        // Автоматическое подключение при загрузке страницы
        window.addEventListener('load', () => {
            // ConsciousnessMonitor.connect(); // Let's connect manually for now
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resonance Liminal - Тест GraphQL подписок</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }
    
    .test-panel {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f9f9f9;
      border-left: 4px solid #3498db;
    }
    
    .test-button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      transition: background-color 0.3s;
    }
    
    .test-button:hover {
      background-color: #2980b9;
    }
    
    .log-container {
      height: 400px;
      overflow-y: auto;
      background-color: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 4px;
      font-family: monospace;
      margin-top: 20px;
    }
    
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #34495e;
      padding-bottom: 5px;
    }
    
    .log-success {
      color: #2ecc71;
    }
    
    .log-error {
      color: #e74c3c;
    }
    
    .log-info {
      color: #3498db;
    }
    
    .log-warning {
      color: #f39c12;
    }
    
    .metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    
    .metric-card {
      flex: 1;
      min-width: 200px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .metric-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    
    .metric-value {
      font-size: 24px;
      color: #3498db;
    }
    
    .progress-bar {
      height: 10px;
      background-color: #ecf0f1;
      border-radius: 5px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #3498db;
      width: 0%;
      transition: width 0.5s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Resonance Liminal - Тест GraphQL подписок</h1>
    
    <div class="test-panel">
      <h2>Панель управления тестами</h2>
      <button id="start-tests" class="test-button">Запустить все тесты</button>
      <button id="test-graph-changes" class="test-button">Тест изменений графа</button>
      <button id="test-state-changes" class="test-button">Тест изменений состояния</button>
      <button id="test-transitions" class="test-button">Тест переходов</button>
      <button id="clear-log" class="test-button">Очистить лог</button>
    </div>
    
    <div class="metrics">
      <div class="metric-card">
        <div class="metric-title">Активное состояние</div>
        <div id="active-state" class="metric-value">-</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">Последний переход</div>
        <div id="last-transition" class="metric-value">-</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">Узлов в графе</div>
        <div id="node-count" class="metric-value">0</div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">Связей в графе</div>
        <div id="link-count" class="metric-value">0</div>
      </div>
    </div>
    
    <div class="metrics">
      <div class="metric-card">
        <div class="metric-title">Уровень присутствия</div>
        <div class="progress-bar">
          <div id="presence-level" class="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">Индекс гармонии</div>
        <div class="progress-bar">
          <div id="harmony-index" class="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">Аутентичность</div>
        <div class="progress-bar">
          <div id="authenticity-score" class="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      
      <div class="metric-card">
        <div class="metric-title">Эмоциональный заряд</div>
        <div class="progress-bar">
          <div id="emotional-charge" class="progress-fill" style="width: 0%"></div>
        </div>
      </div>
    </div>
    
    <h2>Лог событий</h2>
    <div id="log-container" class="log-container"></div>
  </div>
  
  <!-- Загрузка конфигурации -->
  <script src="js/config.js"></script>
  
  <!-- Загрузка GraphQL клиентов -->
  <script src="js/graphql-subscription-client.js"></script>
  <script src="js/graphql-client.js"></script>
  
  <!-- Загрузка сервиса данных -->
  <script src="js/data-service.js"></script>
  
  <!-- Загрузка тестов -->
  <script src="js/test-graphql-subscriptions.js"></script>
  
  <script>
    // Функция для добавления записи в лог
    function log(message, type = 'info') {
      const logContainer = document.getElementById('log-container');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry log-${type}`;
      
      const timestamp = new Date().toLocaleTimeString();
      logEntry.textContent = `[${timestamp}] ${message}`;
      
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    // Инициализация DataService
    let dataService;
    
    // Функция инициализации после загрузки страницы
    window.addEventListener('load', () => {
      log('Страница загружена', 'info');
      
      try {
        // Инициализация сервиса данных
        dataService = new DataService();
        log('DataService инициализирован', 'success');
        
        // Подписка на обновления данных
        dataService.subscribe(data => {
          log('Получены новые данные', 'info');
          updateMetrics(data);
        });
        
        // Настройка обработчиков кнопок
        document.getElementById('start-tests').addEventListener('click', runAllTests);
        document.getElementById('test-graph-changes').addEventListener('click', testGraphChanges);
        document.getElementById('test-state-changes').addEventListener('click', testStateChanges);
        document.getElementById('test-transitions').addEventListener('click', testTransitions);
        document.getElementById('clear-log').addEventListener('click', clearLog);
        
        log('Интерфейс тестирования готов', 'success');
      } catch (error) {
        log(`Ошибка инициализации: ${error.message}`, 'error');
        console.error(error);
      }
    });
    
    // Функция обновления метрик
    function updateMetrics(data) {
      if (!data) return;
      
      // Обновляем счетчики
      document.getElementById('node-count').textContent = data.nodes.length;
      document.getElementById('link-count').textContent = data.links.length;
      
      // Обновляем активное состояние
      if (data.activeState) {
        const activeNode = data.nodes.find(n => n.id === data.activeState);
        if (activeNode) {
          document.getElementById('active-state').textContent = activeNode.label;
          
          // Обновляем метрики состояния
          if (activeNode.metrics) {
            document.getElementById('presence-level').style.width = 
              `${activeNode.metrics.presence_level * 100}%`;
              
            document.getElementById('harmony-index').style.width = 
              `${activeNode.metrics.harmony_index * 100}%`;
              
            document.getElementById('authenticity-score').style.width = 
              `${activeNode.metrics.authenticity_score * 100}%`;
              
            document.getElementById('emotional-charge').style.width = 
              `${activeNode.metrics.emotional_charge}%`;
          }
        }
      }
      
      // Обновляем последний переход
      if (data.activeTransition) {
        const { fromState, toState, trigger } = data.activeTransition;
        const sourceNode = data.nodes.find(n => n.id === fromState);
        const targetNode = data.nodes.find(n => n.id === toState);
        
        if (sourceNode && targetNode) {
          document.getElementById('last-transition').textContent = 
            `${sourceNode.label} → ${targetNode.label}`;
        }
      }
    }
    
    // Функция запуска всех тестов
    function runAllTests() {
      log('Запуск всех тестов', 'info');
      testGraphChanges();
      
      setTimeout(() => {
        testStateChanges();
      }, 2000);
      
      setTimeout(() => {
        testTransitions();
      }, 4000);
    }
    
    // Функция тестирования изменений графа
    function testGraphChanges() {
      log('Тест изменений графа', 'info');
      
      // Создание нового узла
      dataService.createConsciousnessState({
        id: `test-state-${Date.now()}`,
        label: `Тестовое состояние ${Math.floor(Math.random() * 100)}`,
        state: 'PRESENCE_NOW',
        description: 'Состояние создано для тестирования GraphQL подписок'
      })
      .then(result => {
        log(`Создан новый узел: ${result.label}`, 'success');
      })
      .catch(error => {
        log(`Ошибка создания узла: ${error.message}`, 'error');
      });
    }
    
    // Функция тестирования изменений активного состояния
    function testStateChanges() {
      log('Тест изменений активного состояния', 'info');
      
      // Получаем случайный узел
      const nodes = dataService.getNodes();
      if (nodes.length > 0) {
        const randomNode = nodes[Math.floor(Math.random() * nodes.length)];
        
        // Активируем состояние
        dataService.activateConsciousnessState(randomNode.id)
          .then(() => {
            log(`Активировано состояние: ${randomNode.label}`, 'success');
          })
          .catch(error => {
            log(`Ошибка активации состояния: ${error.message}`, 'error');
          });
      } else {
        log('Нет доступных узлов для активации', 'warning');
      }
    }
    
    // Функция тестирования переходов
    function testTransitions() {
      log('Тест выполнения переходов', 'info');
      
      // Получаем узлы
      const nodes = dataService.getNodes();
      if (nodes.length >= 2) {
        const sourceIndex = Math.floor(Math.random() * nodes.length);
        let targetIndex = (sourceIndex + 1) % nodes.length;
        
        const sourceNode = nodes[sourceIndex];
        const targetNode = nodes[targetIndex];
        
        // Выполняем переход
        dataService.executeTransition({
          sourceState: sourceNode.id,
          targetState: targetNode.id,
          trigger: 'DEEP_BREATH',
          triggerData: { intensity: 0.8 }
        })
        .then(() => {
          log(`Выполнен переход: ${sourceNode.label} → ${targetNode.label}`, 'success');
        })
        .catch(error => {
          log(`Ошибка выполнения перехода: ${error.message}`, 'error');
        });
      } else {
        log('Недостаточно узлов для выполнения перехода', 'warning');
      }
    }
    
    // Функция очистки лога
    function clearLog() {
      document.getElementById('log-container').innerHTML = '';
      log('Лог очищен', 'info');
    }
  </script>
</body>
</html>

name: Python Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt', 'requirements-dev.txt') }}

    - name: Install deps (prod + dev)
      run: |
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -e .
        python -m playwright install --with-deps || true

    - name: Export test env
      run: |
        echo "PORT=8080" >> $GITHUB_ENV
        echo "LIMINAL_DB_BACKEND=mock" >> $GITHUB_ENV

    - name: Run API (background)
      run: |
        uvicorn liminal.at_risk_server_neo4j:app --host 0.0.0.0 --port ${{ env.PORT }} &
        for i in {1..90}; do
          if curl -fsS "http://127.0.0.1:${PORT}/at-risk"; then
            echo "API is ready"; break
          fi
          sleep 1
        done
        curl -fsS "http://127.0.0.1:${PORT}/health"

    - name: Run tests (integration/UI)
      run: |
        pytest -q -m integration
